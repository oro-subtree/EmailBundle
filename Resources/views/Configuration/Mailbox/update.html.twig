{% extends 'OroConfigBundle::configPage.html.twig' %}

{% import 'OroEmailBundle::macros.html.twig' as emailUI %}

{% if form.vars.data.id %}
    {% set mailboxTitle = form.vars.data.label %}
{% else %}
    {% set mailboxTitle = 'oro.email.mailbox.action.new'|trans %}
{% endif %}

{% set pageTitle = [
    {
        link: path('oro_config_configuration_system'),
        label: 'oro.config.menu.system_configuration.label'|trans,
    },
    {
        link: path('oro_config_configuration_system', {
                activeGroup: 'platform',
                activeSubGroup: 'email_configuration'
            }),
        label: 'oro.email.system_configuration.email_configuration'|trans,
    },
    mailboxTitle
] %}

{% if form.vars.data.id is not null %}
    {% set formAction = path(
        'oro_email_mailbox_update',
        { id: form.vars.data.id }
    )
    %}
{% else %}
    {% set formAction = path('oro_email_mailbox_create') %}
{% endif %}
{% set routeName = 'oro_config_configuration_system' %}
{% set routeParameters = {} %}

{% import 'OroNavigationBundle:Include:contentTags.html.twig' as navigationMacro %}
{% import 'OroConfigBundle::macros.html.twig' as configUI %}
{% import 'OroUIBundle::macros.html.twig' as UI %}

{% form_theme form with ['OroFormBundle:Form:fields.html.twig', 'OroLocaleBundle:Form:fields.html.twig'] %}

{% if form.vars.value.id %}
    {% oro_title_set({params : {"%label%": form.vars.value.label} }) %}
{% endif %}

{% block content %}
    {% set buttons = '' %}
    {% set html = '' %}
    {% if form.vars.value.id and resource_granted('DELETE', form.vars.value) %}
        {% set buttons = buttons ~ UI.deleteButton({
            'dataUrl': path('oro_email_mailbox_delete', {'id': form.vars.value.id}),
            'dataRedirect': path('oro_config_configuration_system', {
                activeGroup: 'platform',
                activeSubGroup: 'email_configuration'
            }),
            'aCss': 'no-hash remove-button',
            'id': 'btn-remove-mailbox',
            'dataId':  form.vars.value.id,
            'entity_label': 'oro.email.mailbox.entity_label'|trans
        }) %}
        {% set buttons = buttons ~ UI.buttonSeparator() %}
        {% set html = html ~ UI.saveAndStayButton() %}
    {% endif %}

    {% set html = html ~ UI.saveAndCloseButton() %}
    {% set buttons = buttons ~ UI.dropdownSaveButton({'html': html}) %}

    {% set options = {
        el: '#' ~ form.vars.id,
    } %}

    <form
        id="{{ form.vars.id }}"
        name="{{ form.vars.name }}"
        {{ form_enctype(form) }}
        action="{{ formAction }}"
        method="post"
        data-collect="true"
        data-page-component-module="oroconfig/js/form/config-form"
        data-page-component-options="{{ options|json_encode }}"
    >
        {{ emailUI.renderMailboxConfigTitleAndButtons(pageTitle, buttons) }}
        <div class="system-configuration-container left-panel-container">
            <div class="placeholder">
                <div class="scrollable-container">
                    {{ configUI.renderTabs(data, activeGroup, activeSubGroup, routeName, routeParameters) }}
                    <div class="system-configuration-content content form-container" id="configuration-options-block">
                        <div class="pull-right">
                            <input type="hidden" name="input_action" value="" data-form-id="{{ form.vars.id }}"/>
                        </div>
                        {% set fromErrors = form_errors(form) %}
                        {% if formErrors is defined and formErrors | length %}
                            <div class="customer-info-actions container-fluid well-small alert-wrap">
                                <div class="alert alert-error">
                                    <button class="close" type="button" data-dismiss="alert" data-target=".alert-wrap">Ã—</button>
                                    {{ formErrors|raw }}
                                </div>
                            </div>
                        {% endif %}
                        {% set accordionId = 'system-configuration-collapse' %}
                        <div class="accordion">
                            <div class="accordion-group">
                                <div class="accordion-heading">
                                    <div class="pull-right">
                                        {{ configUI.renderCollapseExpandActions('#configuration-options-block') }}
                                    </div>
                                    <a href="#{{ accordionId }}" data-toggle="collapse" class="accordion-toggle">
                                        {{ 'oro.email.system_configuration.mailbox_configuration.label'|trans }}
                                    </a>
                                </div>
                                <div class="accordion-body in collapse" id="{{ accordionId }}" >
                                    <div class="accordion-inner">
                                        {{ form(form) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
    {{ oro_form_js_validation(form) }}
    {{ navigationMacro.navigationContentTags({name: 'system_configuration', params: [activeGroup, activeSubGroup]}) }}
{% endblock content %}
