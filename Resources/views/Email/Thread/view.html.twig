{% extends "OroUIBundle:actions:view.html.twig" %}
{% import "OroEmailBundle::actions.html.twig" as Actions %}

{% oro_title_set({params : {"%subject%": entity.subject} }) %}

{% block pageHeader %}
    {% set breadcrumbs = {
        'entity':      entity,
        'indexPath':   path('oro_email_user_emails'),
        'indexLabel':  'oro.email.entity_plural_label'|trans,
        'entityTitle': entity.subject,
    } %}
    {{ parent() }}
{% endblock pageHeader %}

{% block pageActions %}
    <div class="pull-right email-thread-action-panel"></div>
{% endblock pageActions %}

{% block navButtons %}
    {{ Actions.addContextButton(entity) }}
{% endblock navButtons %}

{% block breadcrumb %}
    {% set breadcrumbs = [
        {'label': 'oro.email.menu.user_emails'|trans }
    ] %}
    {% include 'OroNavigationBundle:Menu:breadcrumbs.html.twig' %}
{% endblock breadcrumb %}

{% block stats %}
    <li class="context-data email-context-activity-block">
        <script type="text/template" id="email-context-activity-list">
            <div class="context-item" style="border: none" data-cid="<%= entity.cid %>">
                <span data-id="<%= entity.get('targetId') %>">
                    <span class="<%= entity.get('icon') %>"></span>

                    <% if (entity.get('link')) { %>
                        <a href="<%= entity.get('link') %>">
                            <span class="context-label"><%= entity.get('title') %></span>
                        </a>
                    <% } else { %>
                        <span class="context-label"><%= entity.get('title') %></span>
                    <% }  %>

                    <i class="icon-remove"></i>
                </span>
            </div>
        </script>

        {% set itemsArray = [] %}
        {% for item in entity.getActivityTargetEntities() %}
            {% set itemClassName = oro_class_name(item) %}
            {% set itemArray = {
                'entityId': entity.id,
                'targetId': item.id,
                "targetClassName": itemClassName ,
                'title': item|oro_format_name|default(item.email)|default(item.id),
                'icon': oro_entity_config_value(itemClassName, 'icon' ),
                'link': path(oro_entity_route(itemClassName), {id:item.id} )
            } %}
            {% set itemsArray = itemsArray|merge([itemArray]) %}
        {% endfor %}
        {% set options = {
            items: itemsArray,
            entityId: entity.id
        } %}

        <div class="email-context-activity">
            <div class="email-context-activity-label">
                Contexts
            </div>
            <div class="email-context-activity-items"
                 data-page-component-module="oroemail/js/app/components/email-context-activity-component"
                 data-page-component-options="{{ options|json_encode }}">
            </div>
        </div>
    </li>
{% endblock %}

{% block content_data %}
    <div class="container-fluid">
        {{ oro_widget_render({
            'widgetType': 'block',
            'wid': 'thread-view',
            'url': path('oro_email_thread_widget', {'id': entity.id, 'renderContexts': false}),
            'alias': 'thread-view',
            'contextsRendered': true
        }) }}
    </div>
{% endblock content_data %}
