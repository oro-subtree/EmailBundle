{% import "OroEmailBundle::actions.html.twig" as Actions %}
{% import 'OroUIBundle::macros.html.twig' as UI %}
{% import 'OroEmailBundle::macros.html.twig' as EA %}

{% if shortEmailThread is not defined and thread|length > 7 %}
    {% set shortEmailThread = true %}
    {% set skippedEmails = [] %}
{% endif %}

<div class="widget-content thread-view">
    {% for email in thread|reverse %}
        {% if shortEmailThread and loop.index > 2 and loop.index < (loop.length - 1) %}
            {% set skippedEmails = skippedEmails|merge([email.id]) %}
            {% if loop.index == loop.length - 2 %}
                load more emails:
                {{ skippedEmails|json_encode }}
            {% endif %}
        {% else %}
            {# email collapsed also can be evaluated for other conditions here #}
            {% set emailCollapsed = not loop.last %}
            <div class="email-info{{ emailCollapsed ? '': ' in'}}">
                <div class="email-short">
                    <div class="email-view-toggle">
                        <div class="pull-right">
                            <div class="email-sent-date">
                                {% if email.emailBody.hasAttachments %}
                                    <i class="icon-paper-clip email-has-attachment"></i>
                                {% endif %}
                                {{ EA.email_sent_at(email) }}
                            </div>
                        </div>
                        <div class="email-participants">
                            <span class="email-author">{{ EA.email_participant_name_or_me(email.fromEmailAddress, email.fromName, true) }}</span>
                            <span class="email-recipients">{{ 'To'|trans|lower }} {{ EA.email_participants_name(email.recipients, true, false) }}</span>
                        </div>
                        <div class="email-body">
                            {# @todo output short email body #}
                            Twig 1.17.0 has just been released. It contains a new “dynamic” autoescaping strategy, named ‘filename’.
                        </div>
                    </div>
                </div>

                <div class="email-full">
                    <div class="email-view-toggle">
                        <div class="pull-right">
                            <div class="email-sent-date">
                            {% if email.emailBody.hasAttachments %}
                                <i class="icon-paper-clip email-has-attachment"></i>
                            {% endif %}
                            {{ EA.email_sent_at(email) }}<br />
                            </div>
                            {% set buttonsHtml %}
                                {{ Actions.replyButton(email) }}
                                {{ Actions.forwardButton(email) }}
                            {% endset %}
                            {{ UI.pinnedDropdownButton({
                                'html': buttonsHtml
                            }) }}
                        </div>
                        <div class="email-participants">
                            <div class="email-author">{{ EA.email_participant_name_or_me(email.fromEmailAddress, email.fromName, true) }}</div>
                            <span class="email-recipients">{{ 'To'|trans }}: {{ EA.email_participants_name(email.recipients, true) }}</span>
                            <div class="email-detailed-info-table dropdown">
                                <span class="dropdown-toggle" data-toggle="dropdown" title="{{ 'oro.email.show_details.tooltip'|trans }}">
                                    <i class="fa fa-chevron-down"></i>
                                </span>
                                <div class="dropdown-menu" role="menu">
                                    {{ EA.email_detailed_info_table(email) }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="email-body">
                        {% if email.emailBody %}
                            {{ email.emailBody.bodyContent|raw }}
                        {% else %}
                            {{ 'oro.email.body_is_unavailable'|trans }}
                        {% endif %}
                    </div>
                    {% if email.emailBody.hasAttachments %}
                        {{ UI.attibuteRow('Attachments'|trans, EA.attachments(email.emailBody.attachments)) }}
                    {% endif %}
                </div>
            </div>
        {% endif %}
    {% endfor %}
</div>
